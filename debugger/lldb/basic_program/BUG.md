# 已知问题记录

## 2025-05-29: TBZ测试导致EXC_BAD_ACCESS崩溃

**问题描述**:
在运行ARM64分支测试时，程序在TBZ测试部分崩溃，出现EXC_BAD_ACCESS (code=1, address=0x1)异常。日志显示在调用printf函数时，第一个参数(x0)被错误设置为1。

**原因分析**:
1. 在`branch_test.s`文件的TBZ测试部分，错误地在调用printf前将x0设置为1
2. x0应包含格式字符串地址，但实际为1
3. 当printf尝试访问0x1地址时触发内存访问异常

**修复方案**:
1. 修改`branch_test.s`中TBZ测试的汇编代码
2. 确保调用printf前正确设置x0为格式字符串地址
3. 将设置测试值的指令移到printf调用之后

**影响范围**:
修复后，TBZ测试将能正常执行而不崩溃。

## 2025-05-29: printf调用导致EXC_BAD_ACCESS崩溃

**问题描述**:
在运行ARM64分支测试时，程序在CBZ测试部分崩溃，出现EXC_BAD_ACCESS (code=1, address=0x0)异常。日志显示在调用printf函数时，第一个参数(x0)被错误设置为0。

**原因分析**:
1. 在`branch_test.s`文件的CBZ测试部分，错误地在调用printf前将x0设置为0
2. x0应包含格式字符串地址，但实际为NULL
3. 当printf尝试访问0x0地址时触发内存访问异常

**修复方案**:
1. 修改`branch_test.s`中CBZ测试的汇编代码
2. 确保调用printf前正确设置x0为格式字符串地址
3. 将设置x0=0的指令移到printf调用之后

**影响范围**:
修复后，CBZ测试将能正常执行而不崩溃。

## 2025-05-30: BR指令测试导致无限循环

**问题描述**:
在运行ARM64分支测试时，测试程序陷入无限循环，不断执行`func3`函数。从日志中可以看到，在`func3`返回后，程序又回到了`adr x9, func3`指令，再次跳转，形成循环。

**原因分析**:
1. 在`branch_test.s`中，测试BR指令时，使用`br x9`跳转到`func3`，但未设置返回地址（LR）。
2. `func3`函数使用`ret`指令返回，而`ret`指令使用LR作为返回地址。
3. 由于未设置LR，LR中保存的是之前调用的返回地址（可能是`_printf`的返回地址），该地址指向`adr x9, func3`指令，导致循环。

**修复方案**:
1. 在`br x9`指令前，使用`adr lr, .Lafter_br`将返回地址设置为`br`指令后的第一条指令。
2. 这样，`func3`返回后，程序会继续执行后续的测试（CBZ/TBZ等），然后正常退出。

**影响范围**:
修复后，BR测试将不会导致无限循环，所有测试将按顺序执行。

## 2025-05-29: ARM64测试程序链接失败

**问题描述**:
构建`branch_test`和`cond_branch_test`时出现链接错误：
```
Undefined symbols for architecture arm64:
  "_main", referenced from:
      <initial-undefines>
```

**原因分析**:
1. 汇编测试程序缺少`main`函数入口点
2. 链接器无法找到程序启动符号
3. 测试程序未与主程序完全分离

**修复方案**:
1. 为每个测试程序添加专用的`main`入口点
2. 创建`test_entry_point.h`统一声明测试函数
3. 更新CMake构建配置
4. 添加`branch_test_main.c`和`cond_branch_test_main.c`

**影响范围**:
修复后，所有ARM64测试程序可独立构建运行。

## 2025-05-29: ARM64分支指令对齐错误

**问题描述**:
在构建`branch_test`时出现多个`fixup not sufficiently aligned`错误，具体位置在分支指令（如b, bl, b.eq等）处。

**原因分析**:
1. ARM64架构要求指令地址必须4字节对齐，分支指令的目标地址也必须对齐
2. 原始代码中分支指令前缺少对齐指令，导致地址不对齐
3. 使用ldr指令加载大立即数可能引起对齐问题

**修复方案**:
1. 在关键分支指令前添加`.align 2`确保4字节对齐
2. 使用movz/movk组合代替ldr加载大立即数
3. 优化代码结构，确保所有跳转标签正确对齐
4. 将字符串常量移到函数外部，避免破坏代码对齐

**影响范围**:
修复后，所有分支指令对齐问题得到解决，程序可以正确构建。

## 2025-05-29: ARM64立即数加载错误

**问题描述**:
在构建`branch_test`时出现错误`expected compatible register or logical immediate`，具体位置在`branch_test.s`中的`mov w0, #100000`指令。

**原因分析**:
1. ARM64的`mov`指令只能加载16位立即数(0-65535)
2. 100000(0x186A0)超过16位范围
3. 原始修复方案(减少睡眠时间)只是临时规避，未根本解决问题

**修复方案**:
1. 使用`ldr w0, =100000`代替`mov`指令
2. 汇编器会自动处理大立即数加载
3. 保持0.1秒睡眠时间不变
4. 完善所有条件分支测试逻辑
5. 修复跳转标签缺失问题

**影响范围**:
修复后所有ARM64分支测试均可正常运行，且睡眠时间保持0.1秒不变。

## 2025-05-29: 条件分支测试未完全实现

**问题描述**:
`cond_branch_test.s`中只实现了EQ和NE条件测试，其他条件分支被注释。

**修复方案**:
1. 完整实现所有条件分支测试
2. 添加GT/LT/GE/LE/CS/CC/MI/PL/VS/VC/HI/LS测试
3. 优化日志输出格式
4. 确保所有跳转都有对应标签

**影响范围**:
现在所有ARM64条件分支指令都得到完整测试。

## 2025-05-29: 重复链接静态库警告

**问题描述**:
构建时出现警告`ignoring duplicate libraries: 'libbasic_lib.a'`

**原因分析**:
CMakeLists.txt中`basic_program`目标链接了两次`basic_lib`库

**修复方案**:
已在CMakeLists.txt中移除重复的链接依赖

**影响范围**:
仅影响构建过程的警告信息，不影响程序功能。

## 2025-05-29: ARM64测试函数链接失败

**问题描述**:
主程序链接时报告找不到`_run_branch_tests`符号。

**原因分析**:
1. 汇编符号命名约定不匹配
2. CMake未正确链接汇编文件

**修复方案**:
1. 使用`__asm__`属性指定正确符号名
2. 添加汇编文件到主程序链接
3. 添加测试脚本验证

**影响范围**:
修复后ARM64测试函数可正常集成到主程序。
